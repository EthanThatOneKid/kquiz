#!/usr/bin/env bash
set -e

schemaFile=types/qg.json
package=qg

exceptions=(
	JeopardyGameData
)

generate() {
	echo "// Code generated by jtd-go-validators. DO NOT EDIT."
	echo
	echo "package $package"
	echo

	defns=( $(jq -r '
		.definitions
			| to_entries
			| .[]
			| select(.value.properties or .value.discriminator)
			| .key
		' < $schemaFile) )
	for defn in "${defns[@]}"; do
		if except "$defn"; then
			continue
		fi
		echo "// Validate validates the $defn object. It implements the"
		echo "// Validator interface."
		echo "func (v *$defn) Validate() error {"
		echo "	return Validate(\"$defn\", v)"
		echo "}"
		echo
	done
}

except() {
	for e in "${exceptions[@]}"; do
		if [[ "$e" == "$1" ]]; then
			return 0
		fi
	done
	return 1
}

main() {
	output="$1"
	if [[ "$output" == "" ]]; then
		echo "Usage: $0 <output>" >&2
		return 1
	fi

	generate > "$output"
	goimports -w "$output"
}

main "$@"
